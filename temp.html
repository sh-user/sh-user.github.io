<!DOCTYPE html><html lang='ru'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=860'>
<title>Home 181</title>

<style>
  body{ background: #cfd8dc; color: #455a64; font-family: Helvetica; font-size: 15px; }
  /*body{ background: #e9ebee; color: #606770; font-family: Helvetica; font-size: 15px; }*/
  ::selection {background: #a0bbbb;}
  ::-moz-selection {background: #a0bbbb;}
  input, textarea, button {outline: none;}
  /*a {color: #606770}*/
  a {color: #455a64}
  h1 {font-size: 18px; font-weight:normal; margin: 0 0 12px 0;}
  .ram0 {width: 860px;}
  .lab1 {width: 33.3%;}
  .lab2 {width: 100%;}
  .lab1, .lab2 {float: left;  margin: 0 0 12px 0;}
  #id_modT1, #id_modT2, #id_modH, #id_modV, #id_modMM, #id_modP
  {width: 234px; height: 234px; margin: 18px 0 8px 0; background: #f7f7f7; 
  	border:1px solid #455a64; -webkit-border-radius: 117px; -moz-border-radius: 117px; border-radius: 117px;}
  .inn { margin: 108px 0 0 0;}
</style>
</head>

<body>
<center>
	<div class='ram0'>
	<div class='lab2' id='connstatus'>Status: Connenting</div>
	<div class='lab1'><h1>Температура в комнате</h1>
	<div id='id_modT1'><div class="inn">Модуль не подключен</div></div><canvas id='chart_T1'></canvas></div>
	<div class='lab1'><h1>Температура на улице</h1>
	<div id='id_modT2'><div class="inn">Модуль не подключен</div></div><canvas id='chart_T2'></canvas></div>
	<div class='lab1'><h1>Атмосферное давление</h1>
	<div id='id_modMM'><div class="inn">Модуль не подключен</div></div><canvas id='chart_MM'></canvas></div>
	<div class='lab2'><h1>Разница температур: <a id='stRT'></a> &degC</h1></div>
	<div class='lab1'><h1>Влажность в комнате</h1>
	<div id='id_modH'><div class="inn">Модуль не подключен</div></div><canvas id='chart_H'></canvas></div>
	<div class='lab1'><h1>Напряжение в сети</h1>
	<div id='id_modV'><div class="inn">Модуль не подключен</div></div><canvas id='chart_V'></canvas></div>
	<div class='lab1'><h1>Потребляемая мощность</h1>
	<div id='id_modP'><div class="inn">Модуль не подключен</div></div><canvas id='chart_P'></canvas></div>
	<div class='lab2'>Версия: 20180922-0012</div>
</center>
</body>

<script type="text/javascript" src="gauge.min.js"></script>
<script type="text/javascript" src="mqttws31.js"></script>
<script type="text/javascript">
var mod1 = 0, mod2 = 0, temp1 = 0, temp2 = -20, humidity = 0, volt = 150;
chart_T1.style.display = 'none';
chart_T2.style.display = 'none';
chart_H.style.display = 'none';
chart_V.style.display = 'none';
chart_MM.style.display = 'none';
chart_P.style.display = 'none';

var PS1 = new RadialGauge({
    renderTo: 'chart_T1',
    width: 250,
    height: 250,
    minValue: 0,
    maxValue: 40,
    majorTicks: ['0','5','10','15','20','25','30','35','40'],
    minorTicks: 5,
    strokeTicks: false,
    highlights  : [
        { from : 28,  to : 30, color : 'rgba(255,153,0,.75)' },
        { from : 30, to : 40, color : 'rgba(220,57,18,.75)' }
    ],
    valueInt: 1,
    valueDec: 1,
    colorPlate: "#f7f7f7",
    colorMajorTicks: "#333333",
    colorMinorTicks: "#333333",
    colorNumbers: "#333333",
    colorValueText: "#333333",
    colorValueBoxRect: "transparent",
    colorValueBoxRectEnd: "transparent",
    colorValueBoxBackground: "transparent",
    colorValueBoxShadow: false,
    colorValueTextShadow: false,
    colorNeedleShadowUp: true,
    colorNeedleShadowDown: false,
    colorNeedle: "rgba(200, 50, 50, .75)",
    colorNeedleEnd: "rgba(200, 50, 50, .75)",
    borderShadowWidth: 6,
    needleType: "arrow",
    needleWidth: 6,
    needleCircleSize: 12,
    animationDuration: 300,
    animationRule: "dequint",
    fontNumbersSize: 24,
    fontValueSize: 46,
    animatedValue: true
});

var PS2 = new RadialGauge({
    renderTo: 'chart_T2',
    width: 250,
    height: 250,
    //minValue: 0,
    value: -40,
    minValue: -40,
    maxValue: 40,
    majorTicks: ['-40','-30','-20','-10','0','10','20','30','40'],
    minorTicks: 10,
    strokeTicks: false,
    highlights  : [
        { from : 28,  to : 30, color : 'rgba(255,153,0,.75)' },
        { from : 30, to : 40, color : 'rgba(220,57,18,.75)' }
    ],
    valueInt: 1,
    valueDec: 1,
	colorPlate: "#f7f7f7",
    colorMajorTicks: "#333333",
    colorMinorTicks: "#333333",
    colorNumbers: "#333333",
    colorValueText: "#333333",    
    colorValueBoxRect: "transparent",
    colorValueBoxRectEnd: "transparent",
    colorValueBoxBackground: "transparent",
    colorValueBoxShadow: false,
    colorValueTextShadow: false,
    colorNeedleShadowUp: true,
    colorNeedleShadowDown: false,
    colorNeedle: "rgba(200, 50, 50, .75)",
    colorNeedleEnd: "rgba(200, 50, 50, .75)",
    borderShadowWidth: 6,
    needleType: "arrow",
    needleWidth: 6,
    needleCircleSize: 12,
    animationDuration: 300,
    animationRule: "dequint",
    fontNumbersSize: 24,
    fontValueSize: 46,
    animatedValue: true
  });

var PS3 = new RadialGauge({
    renderTo: 'chart_H',
    width: 250,
    height: 250,
    minValue: 0,
    maxValue: 100,
    majorTicks: ['0','10','20','30','40','50','60','70','80','90','100'],
    minorTicks: 10,
    strokeTicks: false,
    highlights: false,
    valueInt: 1,
    valueDec: 1,
    colorPlate: "#f7f7f7",
    colorMajorTicks: "#333333",
    colorMinorTicks: "#333333",
    colorNumbers: "#333333",
    colorValueText: "#333333",
    colorValueBoxRect: "transparent",
    colorValueBoxRectEnd: "transparent",
    colorValueBoxBackground: "transparent",
    colorValueBoxShadow: false,
    colorValueTextShadow: false,
    colorNeedleShadowUp: true,
    colorNeedleShadowDown: false,
    colorNeedle: "rgba(200, 50, 50, .75)",
    colorNeedleEnd: "rgba(200, 50, 50, .75)",
    borderShadowWidth: 6,
    needleType: "arrow",
    needleWidth: 6,
    needleCircleSize: 12,
    animationDuration: 300,
    animationRule: "dequint",
    fontNumbersSize: 24,
    fontValueSize: 46,
    animatedValue: true
  });

  var PS4 = new RadialGauge({
    renderTo: 'chart_V',
    width: 250,
    height: 250,
    value:150,
    minValue: 150,
    maxValue: 250,
    majorTicks: ['150','','170','','190','','210','','230','','250'],
    minorTicks: 10,
    strokeTicks: false,
    //highlights: false,
    highlights  : [
        { from : 150,  to : 170, color: 'rgba(220,57,18,.75)' },
        { from : 170, to : 180, color: 'rgba(255,153,0,.75)'  }
    ],
    valueInt: 1,
    valueDec: 1,
    colorPlate: "#f7f7f7",
    colorMajorTicks: "#333333",
    colorMinorTicks: "#333333",
    colorNumbers: "#333333",
    colorValueText: "#333333",
    colorValueBoxRect: "transparent",
    colorValueBoxRectEnd: "transparent",
    colorValueBoxBackground: "transparent",
    colorValueBoxShadow: false,
    colorValueTextShadow: false,
    colorNeedleShadowUp: true,
    colorNeedleShadowDown: false,
    colorNeedle: "rgba(200, 50, 50, .75)",
    colorNeedleEnd: "rgba(200, 50, 50, .75)",
    borderShadowWidth: 6,
    needleType: "arrow",
    needleWidth: 6,
    needleCircleSize: 12,
    animationDuration: 300,
    animationRule: "dequint",
    fontNumbersSize: 24,
    fontValueSize: 46,
    animatedValue: true
  });

var PS5 = new RadialGauge({
    renderTo: 'chart_MM',
    width: 250,
    height: 250,
    minValue: 0,
    maxValue: 100,
    majorTicks: ['0','10','20','30','40','50','60','70','80','90','100'],
    minorTicks: 10,
    strokeTicks: false,
    highlights: false,
    valueInt: 1,
    valueDec: 1,
    colorPlate: "#f7f7f7",
    colorMajorTicks: "#333333",
    colorMinorTicks: "#333333",
    colorNumbers: "#333333",
    colorValueText: "#333333",
    colorValueBoxRect: "transparent",
    colorValueBoxRectEnd: "transparent",
    colorValueBoxBackground: "transparent",
    colorValueBoxShadow: false,
    colorValueTextShadow: false,
    colorNeedleShadowUp: true,
    colorNeedleShadowDown: false,
    colorNeedle: "rgba(200, 50, 50, .75)",
    colorNeedleEnd: "rgba(200, 50, 50, .75)",
    borderShadowWidth: 6,
    needleType: "arrow",
    needleWidth: 6,
    needleCircleSize: 12,
    animationDuration: 300,
    animationRule: "dequint",
    fontNumbersSize: 24,
    fontValueSize: 46,
    animatedValue: true
  });

var PS6 = new RadialGauge({
    renderTo: 'chart_P',
    width: 250,
    height: 250,
    minValue: 0,
    maxValue: 100,
    majorTicks: ['0','10','20','30','40','50','60','70','80','90','100'],
    minorTicks: 10,
    strokeTicks: false,
    highlights: false,
    valueInt: 1,
    valueDec: 1,
    colorPlate: "#f7f7f7",
    colorMajorTicks: "#333333",
    colorMinorTicks: "#333333",
    colorNumbers: "#333333",
    colorValueText: "#333333",
    colorValueBoxRect: "transparent",
    colorValueBoxRectEnd: "transparent",
    colorValueBoxBackground: "transparent",
    colorValueBoxShadow: false,
    colorValueTextShadow: false,
    colorNeedleShadowUp: true,
    colorNeedleShadowDown: false,
    colorNeedle: "rgba(200, 50, 50, .75)",
    colorNeedleEnd: "rgba(200, 50, 50, .75)",
    borderShadowWidth: 6,
    needleType: "arrow",
    needleWidth: 6,
    needleCircleSize: 12,
    animationDuration: 300,
    animationRule: "dequint",
    fontNumbersSize: 24,
    fontValueSize: 46,
    animatedValue: true
  });

  setInterval(function() {
  	PS1.value = temp1;
    PS1.draw();
    PS2.value = temp2;
    PS2.draw();
    var RT = parseFloat(temp2) - parseFloat(temp1);
    RT = RT.toFixed(1);
    if (RT < 0) {RT = RT/-1;}  
    stRT.innerHTML = RT;
    PS3.value = humidity;
    PS3.draw();
    PS4.value = volt;
    PS4.draw();
    PS5.draw();
    PS6.draw();
  }, 400);

 // Create a client instance
  client = new Paho.MQTT.Client("m23.cloudmqtt.com", 33492, "web_" + parseInt(Math.random() * 100, 10));
  // set callback handlers
  client.onConnectionLost = onConnectionLost;
  client.onMessageArrived = onMessageArrived;
  var options = {
    useSSL: true,
    userName: "ivtjhrii",
    password: "_Gnt6HJ2ncka",
    onSuccess: onConnect,
    onFailure: doFail
  }
  // connect the client
  client.connect(options);

  // called when the client connects
  function onConnect() {
    // Once a connection has been made, make a subscription and send a message.
    connstatus.innerHTML = "Status: Connected";
    console.log("onConnect");
    client.subscribe("ESP12/Status");
    client.subscribe("ESP12/T");
    client.subscribe("ESP12/T2");
    client.subscribe("ESP12/H");
    client.subscribe("ESP12/V");

    message = new Paho.MQTT.Message(' ');
    message.destinationName = 'ESP12/Status';
    client.send(message);
  }

  function doFail(e){
    console.log('doFail:' + e.errorMessage);
    connstatus.innerHTML = 'Status: ' + e.errorMessage;
    setTimeout(function(){location.reload();}, 10000);
  }

  // called when the client loses its connection
  function onConnectionLost(e) {
    if (e.errorCode !== 0) {
      console.log('onConnectionLost:' + e.errorMessage);
      connstatus.innerHTML = 'Status: ' + e.errorMessage;
      setTimeout(function(){location.reload();}, 10000);
    }
  }

  // called when a message arrives
  function onMessageArrived(message) {
    console.log(message.destinationName + ':' + message.payloadString);
    
  //   if (message.destinationName == 'ESP12/Status') {
		// if (message.payloadString = '1')
		// mod1 = 0; mod2 = 0;
		// console.log('mod1=' + mod1 + ' mod2=' + mod2);
  //   }
    //температура на улице
	if (message.destinationName == 'ESP12/T2') {temp2 = message.payloadString; 
		id_modT2.style.display = 'none'; chart_T2.style.display = 'block';}
	//температура в комнате
	if (message.destinationName == 'ESP12/T') {temp1 = message.payloadString; 
		id_modT1.style.display = 'none'; chart_T1.style.display = 'block';}
	//влажность в комнате
	if (message.destinationName == 'ESP12/H') {humidity = message.payloadString; 
		id_modH.style.display = 'none'; chart_H.style.display = 'block';}
	//напряжение в сети
	if (message.destinationName == 'ESP12/V') {volt = message.payloadString; 
		id_modV.style.display = 'none'; chart_V.style.display = 'block'; 
	}

	//setTimeout(function(){
		//if (mod1 = 0) { id_modT1.style.display = 'block'; chart_T1.style.display = 'none';}
		//if (mod2 = 0) { id_modT2.style.display = 'block'; chart_T2.style.display = 'none';}
	//},30000);}
  }

</script>
</html>