<!DOCTYPE html><html lang='ru'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=700'>
<title>Home 181</title>

<style>
body{ background: #cfd8dc; color: #455a64; font-family: Helvetica; font-size: 15px; }
::selection {background: #a0bbbb;}
::-moz-selection {background: #a0bbbb;}
input, textarea, button {outline: none;}
h1 {font-size: 30px; font-weight:normal; margin: 0;}

.ram0 {width: 700px;}
.lab1 {width: 50%; float: left;  margin: 0 0 12px 0;}
.lab2 {width: 100%; float: left;  margin: 0 0 12px 0;}
.ch {height: 300px; width: 300px;}

</style>
</head>

<body>
<center>
	<div class='ram0'>
	<div id='connstatus' class='lab2'>-----</div>
	<div class='lab1'><h1>Температура в комнате</h1><div id='chart_T' class='ch'></div></div>
	<div class='lab1'><h1>Температура на улице</h1><div id='chart_T2' class='ch'></div></div>
	<div class='lab2'><h1>Разница температур: <a id='stRT'></a> &degC</h1></div>
	<div class='lab1'><h1>Влажность в комнате</h1><div id='chart_H' class='ch'></div></div>
	<div class='lab1'><h1>Напряжение в сети</h1><div id='chart_V' class='ch'></div></div>
	</div>
</center>
</body>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js" ></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"></script>
<script type="text/javascript">
google.charts.load('current', {'packages':['gauge']});
//google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(drawChart);

var temp1 = 0;
var temp2 = 0;
var volt = 0;
var humidity = 0;
//var cnt = 0;

// gauge variables.
// Google Charts Stuff
     function drawChart() {

        var dataT = google.visualization.arrayToDataTable([['My Value', 'Value'], ['', 0],]);
        var dataT2 = google.visualization.arrayToDataTable([['My Value', 'Value'], ['', 0],]);
        var dataH = google.visualization.arrayToDataTable([['My Value', 'Value'], ['', 0],]);
        var dataV = google.visualization.arrayToDataTable([['My Value', 'Value'], ['', 0],]);

        var opT = {
          min: 0, max: 40,
          width: 300, height: 300,
          yellowFrom:27.5, yellowTo: 30,
          redFrom: 30, redTo: 40,
          minorTicks: 5,
          majorTicks: ["0","5","10","15","20","25","30", "35", "40"]
        };

		var opH = {
          min: 0, max: 100,
          width: 300, height: 300,
          minorTicks: 10,
          majorTicks: ["0","10","20","30","40","50","60","70","80","90","100"]
        };

        var opV = {
          min: 160, max: 240,
          width: 300, height: 300,
          minorTicks: 10,
          majorTicks: ["160","","180","","200","","220","","240"]
        };

        var chart1 = new google.visualization.Gauge(document.getElementById('chart_T'));
        var chart2 = new google.visualization.Gauge(document.getElementById('chart_T2'));
        var chart3 = new google.visualization.Gauge(document.getElementById('chart_H'));
        var chart4 = new google.visualization.Gauge(document.getElementById('chart_V'));
        chart1.draw(dataT, opT);
        chart2.draw(dataT2, opT);
        chart3.draw(dataH, opH);
        chart4.draw(dataV, opV);

        setInterval(function() {
          dataT.setValue(0, 1, temp1);
          chart1.draw(dataT, opT);
          dataT2.setValue(0, 1, temp2);
          chart2.draw(dataT2, opT);
          var RT = parseFloat(temp2) - parseFloat(temp1);
          RT = RT.toFixed(1);
          if (RT < 0) {RT = RT/-1;}  
          stRT.innerHTML = RT;
          dataH.setValue(0, 1, humidity);
          chart3.draw(dataH, opH);
          dataV.setValue(0, 1, volt);
          chart4.draw(dataV, opV);
        }, 400);
      }

// function drawChart2() {
//         var data = google.visualization.arrayToDataTable([
//           ['20:13',  10],
//           ['20:14',  20],
//           ['20:15',  15],
//           ['20:16',  30]
//         ]);

//         var options = {
//           hAxis: {titleTextStyle: {color: '#333'}},
//           vAxis: {minValue: 0}
//         };

//         var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
//         chart.draw(data, options);
//       }


 // Create a client instance
  client = new Paho.MQTT.Client("m23.cloudmqtt.com", 33492, "web_" + parseInt(Math.random() * 100, 10));

  // set callback handlers
  client.onConnectionLost = onConnectionLost;
  client.onMessageArrived = onMessageArrived;
  var options = {
    useSSL: true,
    userName: "ivtjhrii",
    password: "_Gnt6HJ2ncka",
    onSuccess:onConnect,
    onFailure:doFail,
  }

  // connect the client
    client.connect(options);

  // called when the client connects
  function onConnect() {
    // Once a connection has been made, make a subscription and send a message.
    connstatus.innerHTML = "Connected";
    console.log("onConnect");
    client.subscribe("ESP12/T");
    client.subscribe("ESP12/T2");
    client.subscribe("ESP12/H");
    client.subscribe("ESP12/V");

    message = new Paho.MQTT.Message(' ');
    message.destinationName = 'ESP12/Status';
    client.send(message);
  }

  function doFail(e){
    console.log(e);
  }

  // called when the client loses its connection
  function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
      console.log("onConnectionLost:"+responseObject.errorMessage);
      connstatus.innerHTML = responseObject.errorMessage;
    }
  }

  // called when a message arrives
  function onMessageArrived(message) {
    console.log(message.destinationName + ':' + message.payloadString);

    //температура на улице
	if (message.destinationName == 'ESP12/T2') {temp2 = message.payloadString;}
	//температура в комнате
	if (message.destinationName == 'ESP12/T') {temp1 = message.payloadString;}
	//влажность в комнате
	if (message.destinationName == 'ESP12/H') {humidity = message.payloadString;}
	//напряжение в сети
	if (message.destinationName == 'ESP12/V') {volt = message.payloadString;}

    //var polyline= document.getElementById('polyline-id');
    //points = polyline.getAttribute('points');
    //cnt += 10;
    //if (cnt > 350) {cnt = 0;}
    //var pt = Temp * 10;
    //pt = 250 - pt;
    //points += cnt + "," + pt + " ";
    //polyline.setAttribute('points', points );
  }

  function updateChart(){
    dataT.setValue(0, 1, 30);
    chart1.draw(dataT, opT);
    dataT2.setValue(0, 1, 30);
    chart2.draw(dataT2, opT);
    dataH.setValue(0, 1, 30);
    chart3.draw(dataH, opH);
    dataV.setValue(0, 1, 30);
    chart4.draw(dataV, opV);
  }

</script>
</html>