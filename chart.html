<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <title>ESP Chart</title>

<style>
body {color: #455a64; font-family: Helvetica; font-size: 15px;}
input, textarea, button, select, select:focus {outline: none;}

canvas {-moz-user-select: none; -webkit-user-select: none; -ms-user-select: none;}
h1 { font-size: 18px; padding: 6px 0 0 42px;}
h1, h3 {font-weight:normal; margin: 8px 10px 8px 0;}

.ed {height: 36px; background: #fdfdfe; color: #455a64; font-family: Helvetica; font-size: 18px; border: 1px solid gray; border-radius: 4px; padding: 6px; box-shadow: 0 3px 4px rgba(0,0,0,0.1) inset;}
.lab1 {float: left; margin: 0 0 12px 0;}

#id_Inter {display: none;}

@-webkit-keyframes loader { 100% {-webkit-transform: rotate(360deg); transform: rotate(360deg);}}
@-moz-keyframes loader { 100% {-moz-transform: rotate(360deg); transform: rotate(360deg);}}
@keyframes loader { 100% { transform: rotate(360deg);}}
.loader {margin: 0 0 12px 0; float: left; width: 24px; height: 24px; border: 4px solid #000; 
	border-left-color: #333; border-bottom-color: #555; border-right-color: transparent; 
	border-radius: 100%; -webkit-animation: loader 0.8s infinite linear; -moz-animation: 
	loader 0.8s infinite linear; animation: loader 0.8s infinite linear;}

</style>
</head>

<body>
	<div id='id_Load'><div class='loader' id='id_loader'></div><h1>Загрузка...</h1></div>
	<div id='id_Inter'><div class='lab1'><h3>Интервал</h3></div>
    <select id='id_menu' class='ed' onChange="MenuInter();">
  	<option value='1'>За сутки</option>
  	<option value='2'>За неделю</option>
  	<option value='3'>За месяц</option>
	</select></div>
	<div style="width: 90%"><canvas id="canvas"></canvas></div>
	<br>
	<label>Версия: 20180927-1251</label>
	
<script type="text/javascript" src="moment.min.js"></script>
<script type="text/javascript" src="сhart.min.js"></script>
<script type="text/javascript">
	var inter = 1340;

	var color = Chart.helpers.color;
	var config = {
		type: 'line',
		data: {
			datasets: [{
				label: 'Volt',
				backgroundColor: color('#455a64').alpha(0.1).rgbString(),
				borderColor: '#455a64',
				pointRadius: 0,
				hitRadius: 4,
				borderWidth: 1,
				fill: false,
				data: [],
			}]
		},
		options: {

			responsive: true,
			responsiveAnimationDuration: 0, 	// animation duration after a resize
			animation: { duration: 0 }, 		// general animation time    
        	hover: { animationDuration: 0 }, 	// duration of animations when hovering an item
            legend: { display: false },
            tooltips: { displayColors: false },

			title: {
				display: false
				//text: 'Напряжение в сети'
			},
			elements: {
            	line: {	tension: 0 }			// disables bezier curves
        	},
			scales: {
				xAxes: [{
					distribution: 'linear',
					display: true,
					type: 'time',
					time: {	tooltipFormat: "DD.MM.YYYY, hh:mm:ss" }
				}],
				yAxes: [{
					ticks: { beginAtZero:true },
					ticks: {
        				min: 150,
        				max: 260,
        				stepSize: 10
      				},
					display: true
				}]
			}
		}
	};

	window.onload = function() {
		
		LoadChart();
	};


//=============================================================================
function MenuInter() {
	if (id_menu.value == '1') {inter = 1340;}
	if (id_menu.value == '2') {inter = 9380;}
	if (id_menu.value == '3') {inter = 0;}
	LoadChart();
}

//=============================================================================
function LoadChart() {
	// if (typeof myLine != 'undefined') {
 //     window.myLine.destroy();
	// } 
	var ctx = document.getElementById('canvas').getContext('2d');
	window.myLine = new Chart(ctx, config);

	id_Inter.style.display='none';
    id_Load.style.display='block';
	//var app = "https://script.google.com/macros/s/AKfycbymMHRBn2a39ObPxFhRYussNWejaEgDpCjf6FF4OlWsLHbScOR3/exec";
   	var app = "https://script.google.com/macros/s/AKfycbzcBzCF1UHLopqIbyHNvfEjMEnpuhjR5lFIM6H-WxX1xiH-dSE/exec";
   	xhr = new XMLHttpRequest();
   	xhr.open('GET', app);
   	xhr.onreadystatechange = function() {
    if (xhr.readyState !== 4) return;
    if (xhr.status == 200) {
        try {
        	console.log(xhr.responseText);
        	var tab = JSON.parse(xhr.responseText);
        	var res = tab["result"];
        	if (inter == 0) {inter = res.length};
        	for (var i = res.length-inter; i < res.length ; i++) {
		 		config.data.datasets[0].data.push({ x: res[i][0], y: res[i][2] });
			}
        	window.myLine.update();
        } catch(e) {}
        id_Inter.style.display='block';
        id_Load.style.display='none';
     	} 
   }
   xhr.send();
}

</script>
</body>
</html>